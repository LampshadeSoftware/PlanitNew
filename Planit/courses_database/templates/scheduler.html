{% extends 'base.html' %}

{% block javascript %}
    <script type='text/javascript'>

        var scheduleIndex = 0;
        var numSchedules = 0;
        var schedules = [[{}]];

        $(document).ready( function () {
            // SETS UP TABLES
            $('#courses').DataTable({"lengthChange": false, "dom": "<'row'<'col-sm-6'f>>" + "t"});
            $('.dataTables_filter').addClass('pull-left');
            var wishListTable = $('#wishList').DataTable( {
                "bPaginate": false,
                 "searching": false,
                 "info": false,
                 columns: [
                    { title: "Subject" },
                    { title: "Course ID" },
                    { title: "Course Title" },
                    { title: "Remove", "data": null, defaultContent: "<center><button>-</button></center>" }
                ]

            } );
            $('#wishList tbody').on( 'click', 'button', function () {
                var data = wishListTable.row( $(this).parents('tr') ).data();
                removeFromWishList(data[0], data[1], data[2], data[3]);
            } );
            //localStorage.clear();

            // SETS UP CALENDAR
            $('#calendar').fullCalendar({
                defaultDate: moment('2018-01-01'),
                weekends: false,
                defaultView: 'agendaWeek',
                columnHeaderFormat: 'dddd',
                minTime: "08:00:00",
                maxTime: "23:59:00",
                height: "auto",
                eventColor: '#29B89B',
                header:false,

                contentHeight: 600,
                allDaySlot: false,

                events: [{}]
            });

            // DEALS WITH THE TABS FEATURE
            $(".nav-tabs a").click(function(){
                $(this).tab('show');
            });

            // SLIDER INIT
            var timeSlider = document.getElementById('timeSlider');
            noUiSlider.create(timeSlider, {
                connect: true,
                behaviour: 'tap',
                start: [480, 1020],
                step: 30,
                range: {
                    'min': 480,
                    'max': 1020
                }
            });

            var startTime = document.getElementById('startTime');
            var endTime = document.getElementById('endTime');

            timeSlider.noUiSlider.on('update', function( values, handle ) {

                var value = values[handle];

                if ( handle ) { // right handle
                    endTime.value = Math.round(value);
                } else {  // left handle
                    startTime.value = Math.round(value);
                }

                updateSchedules();
            });

            startTime.addEventListener('change', function(){
                timeSlider.noUiSlider.set([this.value, null]);
            });

            endTime.addEventListener('change', function(){
                timeSlider.noUiSlider.set([null, this.value]);
            });


            // MIN/MAX CREDITS INIT
            var creditSlider = document.getElementById('creditSlider');
            noUiSlider.create(creditSlider, {
                connect: true,
                behavior: 'tap',
                start: [12, 18],
                step: 1,
                range: {
                    'min': 1,
                    'max': 20
                }
            });

            var minCredits = document.getElementById('minCredits');
            var maxCredits = document.getElementById('maxCredits');

            creditSlider.noUiSlider.on('update', function (values, handle ) {
                var value = values[handle];

                if ( handle ) {
                    maxCredits.value = Math.round(value);
                } else {
                    minCredits.value = Math.round(value);
                }

                updateSchedules();
            });

            minCredits.addEventListener('change', function() {
                creditSlider.noUiSlider.set([this.value, null]);
            });
            maxCredits.addEventListener('change', function() {
                creditSlider.noUiSlider.set([null, this.value]);
            });


            // CALLS THE UPDATE LAST
            updateSchedules();
        } );

        function updateCalendar() {
            $('#calendar').fullCalendar('removeEvents');
            $('#calendar').fullCalendar('addEventSource', schedules[scheduleIndex]);
            $('#calendar').fullCalendar('rerenderEvents' );
            if (Object.keys(schedules[0][0]).length == 0){
                document.getElementById("scheduleDisplay").innerHTML = "0/0";
            } else {
                document.getElementById("scheduleDisplay").innerHTML = (scheduleIndex+1).toString() + "/" + numSchedules.toString();
            }

        }

        function updateSchedules() {
            var wishList = JSON.parse(localStorage.getItem("wishList")) || {};
            var filters = $('#wishListFilters').serializeArray().reduce(function(obj, item) {
                obj[item.name] = item.value;
                return obj;
            }, {});

            $.ajax({
                url: '{% url "get_schedules" %}',
                method: 'POST',
                data: {
                    "wishList": wishList,
                    "filters": filters,
                    "csrfmiddlewaretoken": '{{ csrf_token }}'
                    },
                dataType: 'json',
                success: function (data) {
                    schedules = data;
                    scheduleIndex = 0;
                    numSchedules = schedules.length;
                    updateCalendar();
                    updateWishListTable();
                }
            });
        }

        function addToWishList(subject, course_id, title, crn) {

            var newWishListEntry = {"subject": subject, "course_id": course_id, "title": title};
            var wishList = JSON.parse(localStorage.getItem("wishList")) || {};
            wishList[crn] = newWishListEntry;
            localStorage.setItem("wishList", JSON.stringify(wishList))

            updateSchedules();

        }

        function removeFromWishList(subject, course_id, title, crn) {
            var wishList = JSON.parse(localStorage.getItem("wishList")) || {};
            delete wishList[crn];
            localStorage.setItem("wishList", JSON.stringify(wishList))

            updateSchedules();
        }

        function scheduleLeft() {
            scheduleIndex -= 1;
            if (scheduleIndex < 0){
                if (numSchedules == 0){
                    scheduleIndex = 0;
                } else {
                    scheduleIndex = numSchedules-1;
                }
            }
            updateCalendar();
        }

        function scheduleRight() {
            scheduleIndex += 1;
            if (scheduleIndex >= numSchedules){
                scheduleIndex = 0;
            }
            updateCalendar();
        }

        function updateWishListTable(){
            var data = [];
            var wishList = JSON.parse(localStorage.getItem("wishList")) || {};
            Object.keys(wishList).forEach(function(key) {
                var row = [wishList[key]["subject"], wishList[key]["course_id"], wishList[key]["title"], key];
                data.push(row);
            });
            $('#wishList').DataTable().clear();
            $('#wishList').DataTable().rows.add(data);
            $('#wishList').DataTable().draw();
        }
    </script>
{% endblock %}

{% block searchTable %}
    <table id="courses" class="display">
        <thead>
            <tr>
                <th>Subject</th>
                <th>Course ID</th>
                <th>Course Title</th>
                <th>Add</th>
            </tr>
        </thead>
        <tbody>
            {% for item in sections %}
            <tr>
                <td> {{ item.subject }}</td>
                <td> {{ item.course_id }} </td>
                <td> {{ item.title }}</td>
                <td style="text-align: center;">
                    <button onclick="addToWishList('{{item.subject}}','{{item.course_id}}','{{item.title}}','{{item.crn}}')">+</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock %}

{% block wishListTable %}
    <table id="wishList" class="display" width="100%"></table>
{% endblock %}

{% block wishListFeatures %}
    <form id="wishListFilters">
        <!-- Time Filter -->
        <p style="display: inline-block;"><strong>Start time:</strong></p>
        <select id="startTime" name="startTime">
            <option value="480" >8:00</option>
            <option value="510" >8:30</option>
            <option value="540" >9:00</option>
            <option value="570" >9:30</option>
            <option value="600" >10:00</option>
            <option value="630" >10:30</option>
            <option value="660" >11:00</option>
            <option value="690" >11:30</option>
            <option value="720" >12:00</option>
            <option value="750" >12:30</option>
            <option value="780" >1:00</option>
            <option value="810" >1:30</option>
            <option value="840" >2:00</option>
            <option value="870" >2:30</option>
            <option value="900" >3:00</option>
            <option value="930" >3:30</option>
            <option value="960" >4:00</option>
            <option value="990" >4:30</option>
            <option value="1020" >5:00</option>
        </select>
        <p style="display: inline-block;"><strong>End time:</strong></p>
        <select id="endTime" name="endTime">
            <option value="480" >8:00</option>
            <option value="510" >8:30</option>
            <option value="540" >9:00</option>
            <option value="570" >9:30</option>
            <option value="600" >10:00</option>
            <option value="630" >10:30</option>
            <option value="660" >11:00</option>
            <option value="690" >11:30</option>
            <option value="720" >12:00</option>
            <option value="750" >12:30</option>
            <option value="780" >1:00</option>
            <option value="810" >1:30</option>
            <option value="840" >2:00</option>
            <option value="870" >2:30</option>
            <option value="900" >3:00</option>
            <option value="930" >3:30</option>
            <option value="960" >4:00</option>
            <option value="990" >4:30</option>
            <option value="1020" >5:00</option>
        </select>
        <div id="timeSlider" style="padding-left: 15px; margin-bottom: 2em;"></div>

        <!-- Credit Filter -->
        <p style="display: inline-block;"><strong>Minimum Credits:</strong></p>
        <select id="minCredits" name="minCredits">
            <option value="1" >1</option>
            <option value="2" >2</option>
            <option value="3" >3</option>
            <option value="4" >4</option>
            <option value="5" >5</option>
            <option value="6" >6</option>
            <option value="7" >7</option>
            <option value="8" >8</option>
            <option value="9" >9</option>
            <option value="10" >10</option>
            <option value="11" >11</option>
            <option value="12" >12</option>
            <option value="13" >13</option>
            <option value="14" >14</option>
            <option value="15" >15</option>
            <option value="16" >16</option>
            <option value="17" >17</option>
            <option value="18" >18</option>
            <option value="19" >19</option>
            <option value="20" >20</option>
        </select>
        <p style="display: inline-block;"><strong>Maximum Credits:</strong></p>
        <select id="maxCredits" name="maxCredits">
            <option value="1" >1</option>
            <option value="2" >2</option>
            <option value="3" >3</option>
            <option value="4" >4</option>
            <option value="5" >5</option>
            <option value="6" >6</option>
            <option value="7" >7</option>
            <option value="8" >8</option>
            <option value="9" >9</option>
            <option value="10" >10</option>
            <option value="11" >11</option>
            <option value="12" >12</option>
            <option value="13" >13</option>
            <option value="14" >14</option>
            <option value="15" >15</option>
            <option value="16" >16</option>
            <option value="17" >17</option>
            <option value="18" >18</option>
            <option value="19" >19</option>
            <option value="20" >20</option>
        </select>
        <div id="creditSlider" style="padding-left: 15px;"></div>
    </form>
{% endblock %}