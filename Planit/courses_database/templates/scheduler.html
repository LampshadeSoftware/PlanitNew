{% extends 'base.html' %}

{% block javascript %}
    <script type='text/javascript'>  // All init function go here
        let coursesDataTable;
        function tablesInit(){
            // "dom": "<'row'<'col-sm-6'f>>" + "t"
            coursesDataTable = $('#courses').DataTable({searching: true, dom: 'lrtp', "lengthChange": false});
            //$('.dataTables_filter').addClass('pull-left');
            $('#subjectInput').on( 'keyup', function () {
                filterCourseTable(this, 0);
            });
            $('#coursenumInput').on( 'keyup', function () {
                filterCourseTable(this, 1);
            });
            $('#titleInput').on( 'keyup', function () {
                filterCourseTable(this, 2);
            });

            // Add event listener for opening and closing details
            $('#courses tbody').on('click', function () {
                let tr = $(this).closest('tr');
                let row = coursesDataTable.row( tr );

                alert(row);
            } );
        }

        function filterCourseTable(element, column) {
            coursesDataTable
                .columns( column )
                .search( element.value )
                .draw();
        }

        function filtersInit(){
            // DAYS OFF FILTER
            $('#daysOff').multipleSelect({
                onClick: function(view) {
                    updateSchedules();
                },
                onCheckAll: function() {
                    updateSchedules();
                },
                onUncheckAll: function() {
                    updateSchedules();
                }
            });
            // ATTRIBUTES FLTER
            $('#attributes').multipleSelect({
                filter: true,
                onClick: function(view) {
                    updateSchedules();
                },
                onCheckAll: function() {
                    updateSchedules();
                },
                onUncheckAll: function() {
                    updateSchedules();
                }
            });
        }

        function calendarInit(){
            $('#calendar').fullCalendar({
                defaultDate: moment('2018-01-01'),
                weekends: false,
                defaultView: 'agendaWeek',
                columnHeaderFormat: 'dddd',
                minTime: "08:00:00",
                maxTime: "23:59:00",
                height: "auto",
                eventColor: '#29B89B',
                header:false,

                contentHeight: 600,
                allDaySlot: false,

                events: [{}]
            });
        }

        function slidersInit() {
            let timeSlider = document.getElementById('timeSlider');
            noUiSlider.create(timeSlider, {
                connect: true,
                behaviour: 'tap',
                start: [480, 1020],
                step: 30,
                range: {
                    'min': 480,
                    'max': 1320
                }
            });

            let startTime = document.getElementById('startTime');
            let endTime = document.getElementById('endTime');

            startTime.addEventListener('change', function(){
                timeSlider.noUiSlider.set([this.value, null]);
            });

            endTime.addEventListener('change', function(){
                timeSlider.noUiSlider.set([null, this.value]);
            });

            timeSlider.noUiSlider.on('update', function( values, handle ) {

                let value = values[handle];

                if ( handle ) { // right handle
                    endTime.value = Math.round(value);
                } else {  // left handle
                    startTime.value = Math.round(value);
                }
                //updateSchedules();
            });
            timeSlider.noUiSlider.on('change', function() {
                updateSchedules();
            });


            // MIN/MAX CREDITS INIT
            let creditSlider = document.getElementById('creditSlider');
            noUiSlider.create(creditSlider, {
                connect: true,
                behavior: 'tap',
                start: [12, 18],
                step: 1,
                range: {
                    'min': 1,
                    'max': 20
                }
            });

            let minCredits = document.getElementById('minCredits');
            let maxCredits = document.getElementById('maxCredits');

            minCredits.addEventListener('change', function() {
                creditSlider.noUiSlider.set([this.value, null]);
            });
            maxCredits.addEventListener('change', function() {
                creditSlider.noUiSlider.set([null, this.value]);
            });

            creditSlider.noUiSlider.on('update', function (values, handle ) {
                let value = values[handle];

                if ( handle ) {
                    maxCredits.value = Math.round(value);
                } else {
                    minCredits.value = Math.round(value);
                }
                //updateSchedules();
            });
            creditSlider.noUiSlider.on('change', function() {
                updateSchedules();
            });
        }
    </script>
    <script type='text/javascript'>

        let scheduleIndex = 0;  // Used to display what schedule the user is currently viewing
        let numSchedules = 0;  // Is the number of schedules for the given filters
        let creditCounts = [];  // The numbers of credits for each scheduleIndex
        let schedules = [[{}]];  // this will be used by FullCalendar so keep this format

        // General course info. Doesn't change based on schedule index
        let coursesInfo = {};  // Is a dictionary that maps "subject+course_id" to an info dict for that course

        $(document).ready( function () {
            //localStorage.clear();

            // SETS UP CALENDAR
            calendarInit();

            // SETS UP TABLES
            tablesInit();

            // SETS UP FILTERS WITH MULTIPLE SELECT
            filtersInit();

            // DEALS WITH THE TABS FEATURE
            $(".nav-tabs a").click(function(){
                $(this).tab('show');
            });

            // SLIDERS INIT
            slidersInit();

            // CALLS THE UPDATE LAST
            updateSchedules(false);
        } );

        // =================================================================
        // MARK: UPDATE FUNCTIONS (FUNCTIONS THAT UPDATE THE UI IN SOME WAY)
        // =================================================================

        function updateSchedules(is_async) {
            if (typeof(is_async)==='undefined') is_async = true;
            let wishList = JSON.parse(localStorage.getItem("wishList")) || {};
            let filters = $('#wishListFilters').serializeArray().reduce(function(obj, item) {
                obj[item.name] = item.value;
                return obj;
            }, {});

            filters["daysOff"] = String($("#daysOff").multipleSelect("getSelects"));
            filters["attr"] = String($("#attributes").multipleSelect("getSelects"));


            // Ajax gets the schedules data in the background (or not in the background if async is false)
            $.ajax({
                url: '{% url "get_schedules" %}',
                method: 'POST',
                data: {
                    "wishList": wishList,
                    "filters": filters,
                    "csrfmiddlewaretoken": '{{ csrf_token }}'
                    },
                dataType: 'json',
                async: is_async,
                success: function (data) {
                    creditCounts = [];
                    coursesInfo = data["coursesInfo"];
                    let raw_schedules = data["schedules"];
                    if (raw_schedules.length > 0){
                        schedules = [];

                        // parses the schedules dictionary into a FullCalendar-readable format
                        for (let i in raw_schedules){
                            creditCounts.push(raw_schedules[i]["total_credits"]);
                            let schedule = [];
                            let sections = raw_schedules[i]["sections"];
                            for (let j in sections){
                                let section = sections[j];

                                let subject = section["subject"];
                                let courseId = section["course_id"];
                                let sectionNum = section["section_num"];
                                let title = section["title"];
                                let numCredits = section["num_credits"];
                                for(let t in section["times"]){
                                    let time = section["times"][t];
                                    let day = time["day"];
                                    let startHour = time["start_hour"];
                                    let startMinute = time["start_minute"];
                                    let endHour = time["end_hour"];
                                    let endMinute = time["end_minute"];
                                    schedule.push({
                                        "title": "[" + numCredits + "] " + subject + " " + courseId + " " + sectionNum + " - " + title,
                                        "start": "2018-01-0" + day + 'T' + startHour + ":" + startMinute,
                                        "end": "2018-01-0" + day + 'T' + endHour + ":" + endMinute,
                                        "color": coursesInfo[subject+courseId]["color"]
                                    });
                                }
                            }
                            schedules.push(schedule);
                        }
                        numSchedules = schedules.length;
                    } else {
                        schedules = [[{}]];
                        numSchedules = 0
                    }

                    scheduleIndex = 0;
                    updateCalendar();
                    updateWishListVisuals();
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    alert("Status: " + textStatus); alert("Error: " + errorThrown);
                }
            });
        }

        function updateWishListVisuals(){
            let wishList = JSON.parse(localStorage.getItem("wishList")) || {};

            let wishListButtons = document.getElementById("wishListButtonsHolder");
            wishListButtons.innerHTML = "";

            if (Object.keys(wishList).length === 0){
                let noButtons = document.createElement("p");
                noButtons.innerHTML = "Go to the search classes tab to add classes.";
                wishListButtons.appendChild(noButtons);
            }

            // Creates the wish list buttons
            Object.keys(wishList).forEach(function(key) {
                let subject = wishList[key]["subject"];
                let course_id = wishList[key]["course_id"];
                let title = wishList[key]["title"];

                let button = document.createElement("button");
                button.innerHTML = subject + " " + course_id;
                if (coursesInfo[subject+course_id]["color"]) {
                    button.style.background = coursesInfo[subject+course_id]["color"];
                    button.style.color = "white";
                }
                button.style.borderRadius = "7px";
                button.style.height = "50px";
                button.style.width = "100px";
                button.addEventListener("click", function () {
                    document.getElementById("courseInfo").style.display = "inline";
                    let courseTitle = document.getElementById("courseTitle");
                    courseTitle.innerHTML = subject + " " + course_id + " - " + title;
                    let description = document.getElementById("courseDescription");
                    description.innerHTML = coursesInfo[subject+course_id]["description"];
                    let addDropButton = document.getElementById("addDropButton");
                    let newAddDrop = addDropButton.cloneNode(true);
                    addDropButton.parentNode.replaceChild(newAddDrop, addDropButton);
                    newAddDrop.addEventListener("click", function () {
                        removeFromWishList(subject, course_id);
                    })
                });
                wishListButtons.appendChild(button);
            });
        }

        function updateCalendar() {
            let calendar = $('#calendar');
            calendar.fullCalendar('removeEvents');
            calendar.fullCalendar('addEventSource', schedules[scheduleIndex]);
            calendar.fullCalendar('rerenderEvents');
            if (numSchedules === 0){
                document.getElementById("scheduleDisplay").innerHTML = "0/0";
            } else {
                document.getElementById("scheduleDisplay").innerHTML = (scheduleIndex+1).toString() + "/" + numSchedules.toString()
                    + " (" + creditCounts[scheduleIndex] + " credits)";
            }

        }

        function filterCourses() {
            let subjectInput =$("#subjectInput").val();
            let inputString = subjectInput.toUpperCase();

            let table = document.getElementById("courses");
            let tr = table.getElementsByTagName("tr");

            // Loop through all table rows, and hide those who don't match the search query
            for (let i = 0; i < tr.length; i++) {
                let td = tr[i].getElementsByTagName("td")[0];
                if (td) {
                    let found = td.innerHTML.toUpperCase();
                    if (found.indexOf(inputString) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }
        // =======================================================================
        // MARK: USER INTERACTIONS (FUNCTIONS THAT RUN WHEN A USER CLICKS A BUTTON
        // =======================================================================

        function addToWishList(subject, course_id, title) {
            let newWishListEntry = {"subject": subject, "course_id": course_id, "title": title};
            let wishList = JSON.parse(localStorage.getItem("wishList")) || {};

            if (!(subject+course_id in wishList)) {
                wishList[subject + course_id] = newWishListEntry;
                localStorage.setItem("wishList", JSON.stringify(wishList));

                $.notify(
                    "Added " + subject + " " + course_id + " to wish list.", "success",
                    {position: "top"}
                );
                updateSchedules();
            } else {
                $.notify(
                    "You've already added " + subject + " " + course_id + " to your wish list.",
                    {position: "top right"}
                );
            }
        }

        function removeFromWishList(subject, course_id) {
            let wishList = JSON.parse(localStorage.getItem("wishList")) || {};
            delete wishList[subject+course_id];
            localStorage.setItem("wishList", JSON.stringify(wishList));

            $.notify(
                "Removed " + subject + " " + course_id + " from wish list.", "success",
                { position:"top" }
            );

            updateSchedules();
        }

        function scheduleLeft() {
            scheduleIndex -= 1;
            if (scheduleIndex < 0){
                if (numSchedules === 0){
                    scheduleIndex = 0;
                } else {
                    scheduleIndex = numSchedules-1;
                }
            }
            updateCalendar();
        }

        function scheduleRight() {
            scheduleIndex += 1;
            if (scheduleIndex >= numSchedules){
                scheduleIndex = 0;
            }
            updateCalendar();
        }
    </script>
{% endblock %}

{% block searchTable %}
    <table id="searchOptions" class="display" border="0" cellspacing="5" cellpadding="5">
        <tbody>
            <tr>
                <td>Subject:</td>
                <td><input type="text" id="subjectInput" name="subjectInput" onkeyup="filterCourses()"></td>
            </tr>
            <tr>
                <td>Course Number:</td>
                <td><input type="text" id="coursenumInput" name="coursenumInput"></td>
            </tr>
            <tr>
                <td>Title:</td>
                <td><input type="text" id="titleInput" name="titleInput"></td>
            </tr>
        </tbody>
    </table>
    <table id="courses" class="display">
        <thead>
            <tr>
                <th>Subject</th>
                <th>Course ID</th>
                <th>Course Title</th>
                <th>Add</th>
            </tr>
        </thead>
        <tbody>
            {% for item in sections %}
            <tr>
                <td> {{ item.subject }}</td>
                <td> {{ item.course_id }} </td>
                <td> {{ item.title }}</td>
                <td style="text-align: center;">
                    <button onclick="addToWishList('{{item.subject}}','{{item.course_id}}','{{item.title}}')">+</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock %}

{% block coursesInfo %}
    <div id="courseInfo" style="display: none">
        <strong><h4 id="courseTitle">Course Title</h4></strong>
        <button id="addDropButton">Remove Course</button>
        <p id="courseDescription">Description</p>
    </div>
{% endblock %}

{% block wishListFeatures %}
    <div id="wishListButtonsHolder" style="padding-top: 7px"></div>
    <hr>
    <form id="wishListFilters">
        <!-- Time Filter -->
        <label for="startTime">Start Time:</label>
        <select id="startTime" name="startTime" onchange="updateSchedules()">
            <option value="480" >8:00</option>
            <option value="510" >8:30</option>
            <option value="540" >9:00</option>
            <option value="570" >9:30</option>
            <option value="600" >10:00</option>
            <option value="630" >10:30</option>
            <option value="660" >11:00</option>
            <option value="690" >11:30</option>
            <option value="720" >12:00</option>
            <option value="750" >12:30</option>
            <option value="780" >1:00</option>
            <option value="810" >1:30</option>
            <option value="840" >2:00</option>
            <option value="870" >2:30</option>
            <option value="900" >3:00</option>
            <option value="930" >3:30</option>
            <option value="960" >4:00</option>
            <option value="990" >4:30</option>
            <option value="1020" >5:00</option>
        </select>
        <label for="endTime">End Time:</label>
        <select id="endTime" name="endTime" onchange="updateSchedules()">
            <option value="480" >8:00</option>
            <option value="510" >8:30</option>
            <option value="540" >9:00</option>
            <option value="570" >9:30</option>
            <option value="600" >10:00</option>
            <option value="630" >10:30</option>
            <option value="660" >11:00</option>
            <option value="690" >11:30</option>
            <option value="720" >12:00</option>
            <option value="750" >12:30</option>
            <option value="780" >1:00</option>
            <option value="810" >1:30</option>
            <option value="840" >2:00</option>
            <option value="870" >2:30</option>
            <option value="900" >3:00</option>
            <option value="930" >3:30</option>
            <option value="960" >4:00</option>
            <option value="990" >4:30</option>
            <option value="1020" >5:00</option>
            <option value="1050" >5:30</option>
            <option value="1080" >6:00</option>
            <option value="1110" >6:30</option>
            <option value="1140" >7:00</option>
            <option value="1170" >7:30</option>
            <option value="1200" >8:00</option>
            <option value="1230" >8:30</option>
            <option value="1260" >9:00</option>
            <option value="1290" >9:30</option>
            <option value="1320" >10:00</option>
        </select>
        <div id="timeSlider" style="padding-left: 15px; margin-bottom: 2em;"></div>

        <!-- Credit Filter -->
        <label for="minCredits">Minimum Credits:</label>
        <select id="minCredits" name="minCredits" onchange="updateSchedules()">
            <option value="1" >1</option>
            <option value="2" >2</option>
            <option value="3" >3</option>
            <option value="4" >4</option>
            <option value="5" >5</option>
            <option value="6" >6</option>
            <option value="7" >7</option>
            <option value="8" >8</option>
            <option value="9" >9</option>
            <option value="10" >10</option>
            <option value="11" >11</option>
            <option value="12" >12</option>
            <option value="13" >13</option>
            <option value="14" >14</option>
            <option value="15" >15</option>
            <option value="16" >16</option>
            <option value="17" >17</option>
            <option value="18" >18</option>
            <option value="19" >19</option>
            <option value="20" >20</option>
        </select>
        <label for="maxCredits">Maximum Credits:</label>
        <select id="maxCredits" name="maxCredits" onchange="updateSchedules()">
            <option value="1" >1</option>
            <option value="2" >2</option>
            <option value="3" >3</option>
            <option value="4" >4</option>
            <option value="5" >5</option>
            <option value="6" >6</option>
            <option value="7" >7</option>
            <option value="8" >8</option>
            <option value="9" >9</option>
            <option value="10" >10</option>
            <option value="11" >11</option>
            <option value="12" >12</option>
            <option value="13" >13</option>
            <option value="14" >14</option>
            <option value="15" >15</option>
            <option value="16" >16</option>
            <option value="17" >17</option>
            <option value="18" >18</option>
            <option value="19" >19</option>
            <option value="20" >20</option>
        </select>
        <div id="creditSlider" style="padding-left: 15px; margin-bottom: 2em;"></div>

        <!-- Days Off Filter -->
        <label for="daysOff">Days Off</label>
        <select class="w300" multiple="multiple" id="daysOff">
            <option name="day" value="M"> Monday</option>
            <option name="day" value="T"> Tuesday</option>
            <option name="day" value="W"> Wednesday</option>
            <option name="day" value="R"> Thursday</option>
            <option name="day" value="F"> Friday</option>
        </select>
        <br><br>

        <!-- Attributes Filter -->
        <label for="attributes">Attributes</label>
        <select class="w300" multiple="multiple" id="attributes">
            <option value="ACTV"> Active Learning -- ACTV</option>
            <option value="FEE"> Additional Fee Required -- FEE</option>
            <option value="ALB"> American Lit before 1920 -- ALB</option>
            <option value="ALV"> Arts Letters Values -- ALV</option>
            <option value="GE6"> Arts Proficiency (GER6) -- GE6</option>
            <option value="BLB"> British Lit before 1700 -- BLB</option>
            <option value="BLT"> British Lit between 1700-1900 -- BLT</option>
            <option value="BLWF"> Business Law - Foundational -- BLWF</option>
            <option value="BLWS"> Business Law - Supporting -- BLWS</option>
            <option value="CHEL"> Chemistry Electives -- CHEL</option>
            <option value="CSOT"> CLST Other Courses -- CSOT</option>
            <option value="C100"> College 100 -- C100</option>
            <option value="C150"> College 150 -- C150</option>
            <option value="C200"> College 200 -- C200</option>
            <option value="C300"> College 300 -- C300</option>
            <option value="C400"> College 400 -- C400</option>
            <option value="MATC"> Computational Mathematics -- MATC</option>
            <option value="CR"> Constructions of Race -- CR</option>
            <option value="CLS"> Crim, Law, &amp; Society -- CLS</option>
            <option value="CSI" > Culture Society Individual -- CSI</option>
            <option value="DC" > Department Chair Required -- DC</option>
            <option value="ECWR" >ECON Writing Requirement -- ECWR</option>
            <option value="EXP" >Experiential -- EXP</option>
            <option value="FRSM" >First-Year Seminar -- FRSM</option>
            <option value="FLP" >Foreign Lang Proficiency -- FLP</option>
            <option value="G2LA" >G2LA Natural Sci-Physical Lab -- G2LA</option>
            <option value="G2LB" >G2LB Natural Sci-Bio Lab -- G2LB</option>
            <option value="GE1" >GE1Math/Quantitative Reasoning -- GE1</option>
            <option value="GE2A" >GE2A Natural Sci-Physical -- GE2A</option>
            <option value="GE2B" >GE2B Natural Sci-Biological -- GE2B</option>
            <option value="GE2L" >GE2L Natural Science Lab -- GE2L</option>
            <option value="GE3" >GE3 Social Sciences -- GE3</option>
            <option value="GE4A" >GE4A Hist/Cultr Euro Tradition -- GE4A</option>
            <option value="GE4B" >GE4B Hist/Cult outside EurTrad -- GE4B</option>
            <option value="GE4C" >GE4C Cross-Cultural Issues -- GE4C</option>
            <option value="GE5" >GE5 Lit/Hist of the Arts -- GE5</option>
            <option value="GE7" >GE7 Phil/Relig/Soc Thought -- GE7</option>
            <option value="GLOB" >Globalization -- GLOB</option>
            <option value="GUAR" >Guaranteed Summer Offering -- GUAR</option>
            <option value="HMWB" >Health, Med, &amp; Well-Being -- HMWB</option>
            <option value="HIPP" >High Impact Projects -- HIPP</option>
            <option value="HIPT" >High Impact Projects -- HIPT</option>
            <option value="HISC" >HIST Colloquium Requirement -- HISC</option>
            <option value="HINW" >HIST Non-Western Survey Course -- HINW</option>
            <option value="IRCP" >INRL Capstone -- IRCP</option>
            <option value="IREL" >INRL Elective -- IREL</option>
            <option value="IRSC" >INRL Social Cultural Concepts -- IRSC</option>
            <option value="IN" >Instructor Permission Required -- IN</option>
            <option value="JDST" >Judaic Studies Requirement -- JDST</option>
            <option value="KINA" >KINE Activity -- KINA</option>
            <option value="EPPH" >KINE Epidemiology Pub Hlth -- EPPH</option>
            <option value="LWWR" >Law Writing Requirement -- LWWR</option>
            <option value="LW1R" >Law Year 1 Requirement -- LW1R</option>
            <option value="LW2R" >Law Year 2 Requirement -- LW2R</option>
            <option value="LS" >Literature since 1900 -- LS</option>
            <option value="LDWR" >Lower Divsn Writing Req -- LDWR</option>
            <option value="MMTG" >Mandatory Meeting -- MMTG</option>
            <option value="MATH" >Math Proficiency -- MATH</option>
            <option value="MCR" >Meets Major Computing Req -- MCR</option>
            <option value="MWR" >Meets Major Writing Req -- MWR</option>
            <option value="MCGD" >Molecules/Cells/Genes/Develop -- MCGD</option>
            <option value="NQR" >Nat World Quant Reasoning -- NQR</option>
            <option value="NATV" >Natv Stds Minor Core -- NATV</option>
            <option value="ON" >Online Course -- ON</option>
            <option value="MATO" >Operations Research -- MATO</option>
            <option value="OWR" >Optional Writing Requirement -- OWR</option>
            <option value="OPEE" >Organsms/Popultns/Ecology/Evol -- OPEE</option>
            <option value="P/F" >Pass/Fail Course -- P/F</option>
            <option value="PACT" >Physical Activity Proficiency -- PACT</option>
            <option value="MATP" >Probability &amp; Statistics -- MATP</option>
            <option value="MATS" >Scientific Applications -- MATS</option>
            <option value="SHCR" >Short Course -- SHCR</option>
            <option value="SA" >Single Author/Film Auteur -- SA</option>
            <option value="SPPJ" >Soc Prob, Pol, &amp; Justice -- SPPJ</option>
            <option value="SUST" >Sustainability Courses -- SUST</option>
            <option value="UNSM" >University Seminar Req -- UNSM</option>
        </select>
    </form>
    <hr>
{% endblock %}
